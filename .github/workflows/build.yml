name: CI

on:
  pull_request:
    branches:
      - master
  # This CI will be triggered on any merge_group events
  merge_group:
  schedule:
    - cron: "0 0 * * *"  # Run CI on Daily, so we can track changes from nightly rust & Intel PCS

env:
  RUST_BACKTRACE: 1
  CARGO_TERM_COLOR: always
  CARGO_INCREMENTAL: 0
  CARGO_NET_RETRY: 10
  CFLAGS_x86_64_fortanix_unknown_sgx: "-isystem/usr/include/x86_64-linux-gnu -mlvi-hardening -mllvm -x86-experimental-lvi-inline-asm-hardening"
  CC_x86_64_fortanix_unknown_sgx: clang-18
  CC_x86_64-unknown-linux-gnu: clang-18
  CXX_x86_64-unknown-linux-gnu: clang-18

jobs:
  build-test:
    name: Build+Test (${{ matrix.group }})
    runs-on: ubuntu-24.04
    strategy:
      fail-fast: true
      matrix:
        include:
          - group: stable-tests-all
            needs_nightly: false
            needs_sgx: false
            needs_musl: false
            commands: |
              cargo test --verbose --locked --all --exclude sgxs-loaders --exclude async-usercalls && [ "$(echo $(nm -D target/debug/sgx-detect|grep __vdso_sgx_enter_enclave))" = "w __vdso_sgx_enter_enclave" ]
          - group: stable-tests-separate
            needs_nightly: false
            needs_sgx: false
            needs_musl: false
            commands: |
              cargo test --verbose --locked -p dcap-artifact-retrieval --features rustls-tls
              cargo test --verbose --locked -p dcap-ql --features link
              cargo test --verbose --locked -p dcap-ql --features verify
              cargo test --verbose --locked -p ias --features mbedtls
              cargo test --verbose --locked -p ias --features client,mbedtls
              cargo test --locked -p nitro-attestation-verify --no-run && faketime '2021-09-10 11:00:00 GMT' cargo test --locked -p nitro-attestation-verify --lib
          - group: nightly-sgx
            needs_nightly: true
            needs_sgx: true
            needs_musl: false
            commands: |
              cargo +nightly test --verbose --locked -p async-usercalls --target x86_64-fortanix-unknown-sgx --no-run
              cargo +nightly test --verbose --locked -p dcap-artifact-retrieval --target x86_64-fortanix-unknown-sgx --no-default-features --no-run
              cargo +nightly build --verbose --locked -p aesm-client --target=x86_64-fortanix-unknown-sgx
              cargo +nightly build --verbose --locked -p aesm-client --target=x86_64-fortanix-unknown-sgx --features sgx-isa/sgxstd
              cargo +nightly test --verbose --locked -p sgx-isa --features sgxstd --target x86_64-fortanix-unknown-sgx --no-run
              cargo +nightly test --verbose --locked -p pcs --target x86_64-fortanix-unknown-sgx --no-run
              cargo +nightly test --verbose --locked -p pcs --features verify
              cargo +nightly test -p insecure-time --features estimate_crystal_clock_freq
              cargo +nightly build -p insecure-time --features estimate_crystal_clock_freq --target x86_64-fortanix-unknown-sgx
              cargo build --verbose --locked -p em-app -p get-certificate --target=x86_64-fortanix-unknown-sgx
          - group: musl-builds
            needs_nightly: false
            needs_sgx: false
            needs_musl: true
            commands: |
              mkdir -p /tmp/muslinclude
              ln -sf /usr/include/x86_64-linux-gnu/openssl /tmp/muslinclude/openssl
              PKG_CONFIG_ALLOW_CROSS=1 CFLAGS=-I/tmp/muslinclude CARGO_TARGET_X86_64_UNKNOWN_LINUX_MUSL_LINKER=true cargo build --locked -p fortanix-sgx-tools --target x86_64-unknown-linux-musl
              cargo build --verbose --locked -p em-app -p get-certificate --target=x86_64-unknown-linux-musl
          - group: docs
            needs_nightly: true
            needs_sgx: true
            needs_musl: false
            commands: |
              ./doc/generate-api-docs.sh
          - group: examples
            needs_nightly: false
            needs_sgx: false
            needs_musl: false
            commands: |
              cd ./examples/mem-alloc-test && cargo run
              cd ../mem-correctness-test && cargo run

    env:
      CMAKE_POLICY_VERSION_MINIMUM: 3.5

    steps:
    - uses: actions/checkout@v6

    - name: Conditionally export PCS_API_KEY and PCCS_URL
      run: |
        if [ -n "${{ secrets.PCS_API_KEY }}" ]; then
          echo "PCS_API_KEY=${{ secrets.PCS_API_KEY }}" >> $GITHUB_ENV
        fi
        if [ -n "${{ vars.PCCS_URL }}" ]; then
          echo "PCCS_URL=${{ vars.PCCS_URL }}" >> $GITHUB_ENV
        fi

    - name: Install additional dependencies
      run: |
        # install gpg
        sudo apt-get update -y && sudo apt install -y gpg
        # Add intel-sgx package repository, key is download from https://download.01.org/intel-sgx/sgx_repo/ubuntu/intel-sgx-deb.key
        cat intel-sgx-deb.key | gpg --dearmor | sudo tee /usr/share/keyrings/intel-sgx-deb.gpg > /dev/null
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/intel-sgx-deb.gpg] https://download.01.org/intel-sgx/sgx_repo/ubuntu noble main" | sudo tee /etc/apt/sources.list.d/intel-sgx-deb.list > /dev/null
        # Install dependencies for build & test
        sudo apt-get update -y
        sudo apt-get install -y faketime protobuf-compiler libsgx-dcap-ql-dev clang-18 musl-tools gcc-multilib

    - name: Setup Rust toolchains and targets
      run: |
        rustup toolchain install stable --profile minimal
        if [ "${{ matrix.needs_nightly }}" = "true" ]; then
          rustup toolchain install nightly --profile minimal
        fi
        if [ "${{ matrix.needs_sgx }}" = "true" ]; then
          rustup target add x86_64-fortanix-unknown-sgx
          if [ "${{ matrix.needs_nightly }}" = "true" ]; then
            rustup target add x86_64-fortanix-unknown-sgx --toolchain nightly
          fi
        fi
        if [ "${{ matrix.needs_musl }}" = "true" ]; then
          rustup target add x86_64-unknown-linux-musl
        fi

    - uses: Swatinem/rust-cache@v2
      with:
        shared-key: ${{ matrix.group }}
        cache-all-crates: true

    - name: Run matrix commands
      run: |
        ${{ matrix.commands }}

  build-test-summary:
    name: Build+Test
    runs-on: ubuntu-24.04
    needs: [build-test]
    if: ${{ always() }}
    steps:
    - name: Summarize Build+Test matrix
      run: |
        if [ "${{ needs.build-test.result }}" != "success" ]; then
          echo "Build+Test matrix failed"
          exit 1
        fi
        echo "Build+Test matrix succeeded"
